data "http" "my_ip" {
  url = "http://icanhazip.com"
}

module "vpc" {
  source       = "./vpc"
  aws_region   = "${var.aws_region}"
  env          = "${var.env}"
  az_count     = "${var.az_count}"
  vpc_cidr     = "${var.vpc_cidr}"
  vpc_basename = "${var.vpc_basename}"
}

module "snowplow" {
  source                                      = "./snowplow"
  my_ip                                       = "${data.http.my_ip.body}"
  env                                         = "${var.env}"
  department                                  = "${var.department}"
  aws_region                                  = "${var.aws_region}"
  vpc_id                                      = "${module.vpc.vpc_id}"
  subnets                                     = "${module.vpc.subnets}"
  snowplow_service_user                       = "${var.snowplow_service_user}"
  snowplow_service_group                      = "${var.snowplow_service_group}"
  snowplow_home                               = "${var.snowplow_home}"
  snowplow_system_tag                         = "${var.snowplow_system_tag}"
  snowplow_ec2_keypair                        = "${var.snowplow_ec2_keypair}"
  snowplow_ec2_keypair_path                   = "${var.snowplow_ec2_keypair_path}"
  snowplow_lb_port                            = "${var.snowplow_lb_port}"
  snowplow_lb_protocol                        = "${var.snowplow_lb_protocol}"
  snowplow_lb_target_group_protocol           = "${var.snowplow_lb_target_group_protocol}"
  snowplow_lb_health_path                     = "${var.snowplow_lb_health_path}"
  snowplow_lb_healthy_threshold               = "${var.snowplow_lb_healthy_threshold}"
  snowplow_lb_unhealthy_threshold             = "${var.snowplow_lb_unhealthy_threshold}"
  snowplow_lb_health_timeout                  = "${var.snowplow_lb_health_timeout}"
  snowplow_lb_health_interval                 = "${var.snowplow_lb_health_interval}"
  snowplow_collector_ami_id                   = "${var.snowplow_collector_ami_id}"
  snowplow_collector_instance_class           = "${var.snowplow_collector_instance_class}"
  snowplow_collector_root_block_size_gigs     = "${var.snowplow_collector_root_block_size_gigs}"
  snowplow_collector_node_count               = "${var.snowplow_collector_node_count}"
  snowplow_collector_ingress_port             = "${var.snowplow_collector_ingress_port}"
  snowplow_enricher_ami_id                    = "${var.snowplow_enricher_ami_id}"
  snowplow_enricher_instance_class            = "${var.snowplow_enricher_instance_class}"
  snowplow_enricher_root_block_size_gigs      = "${var.snowplow_enricher_root_block_size_gigs}"
  snowplow_enricher_node_count                = "${var.snowplow_enricher_node_count}"
  snowplow_collector_version                  = "${var.snowplow_collector_version}"
  snowplow_collector_buffer_byte_limit        = "${var.snowplow_collector_buffer_byte_limit}"
  snowplow_collector_buffer_record_limit      = "${var.snowplow_collector_buffer_record_limit}"
  snowplow_collector_buffer_time_limit        = "${var.snowplow_collector_buffer_time_limit}"
  snowplow_collector_good_stream              = "${var.snowplow_collector_good_stream}"
  snowplow_collector_good_shard_count         = "${var.snowplow_collector_good_shard_count}"
  snowplow_collector_good_retention_hours     = "${var.snowplow_collector_good_retention_hours}"
  snowplow_collector_bad_stream               = "${var.snowplow_collector_bad_stream}"
  snowplow_collector_bad_shard_count          = "${var.snowplow_collector_bad_shard_count}"
  snowplow_collector_bad_retention_hours      = "${var.snowplow_collector_bad_retention_hours}"
  snowplow_enricher_version                   = "${var.snowplow_enricher_version}"
  snowplow_enricher_buffer_byte_limit         = "${var.snowplow_enricher_buffer_byte_limit}"
  snowplow_enricher_buffer_record_limit       = "${var.snowplow_enricher_buffer_record_limit}"
  snowplow_enricher_buffer_time_limit         = "${var.snowplow_enricher_buffer_time_limit}"
  snowplow_enricher_good_stream               = "${var.snowplow_enricher_good_stream}"
  snowplow_enricher_good_shard_count          = "${var.snowplow_enricher_good_shard_count}"
  snowplow_enricher_good_retention_hours      = "${var.snowplow_enricher_good_retention_hours}"
  snowplow_enricher_bad_stream                = "${var.snowplow_enricher_bad_stream}"
  snowplow_enricher_pii_stream                = "${var.snowplow_enricher_pii_stream}"
  snowplow_enricher_pii_shard_count           = "${var.snowplow_enricher_pii_shard_count}"
  snowplow_enricher_pii_retention_hours       = "${var.snowplow_enricher_pii_retention_hours}"
  snowplow_enricher_bad_shard_count           = "${var.snowplow_enricher_bad_shard_count}"
  snowplow_enricher_bad_retention_hours       = "${var.snowplow_enricher_bad_retention_hours}"
  snowplow_enricher_checkpoint_table          = "${var.snowplow_enricher_checkpoint_table}"
  snowplow_enricher_checkpoint_write_capacity = "${var.snowplow_enricher_checkpoint_write_capacity}"
  snowplow_enricher_checkpoint_read_capacity  = "${var.snowplow_enricher_checkpoint_read_capacity}"
  snowplow_sink_version                       = "${var.snowplow_sink_version}"
  snowplow_sink_buffer_byte_limit             = "${var.snowplow_sink_buffer_byte_limit}"
  snowplow_sink_buffer_record_limit           = "${var.snowplow_sink_buffer_record_limit}"
  snowplow_sink_buffer_time_limit             = "${var.snowplow_sink_buffer_time_limit}"
  snowplow_sink_good_s3_bucket                = "${var.snowplow_sink_good_s3_bucket}"
  snowplow_sink_bad_stream                    = "${var.snowplow_sink_bad_stream}"
  snowplow_sink_bad_shard_count               = "${var.snowplow_sink_bad_shard_count}"
  snowplow_sink_checkpoint_table              = "${var.snowplow_sink_checkpoint_table}"
  snowplow_sink_checkpoint_write_capacity     = "${var.snowplow_sink_checkpoint_write_capacity}"
  snowplow_sink_checkpoint_read_capacity      = "${var.snowplow_sink_checkpoint_read_capacity}"
}
